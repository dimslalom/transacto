<!-- templates/index.html -->
<!DOCTYPE html>
<html>
<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>Data Lake Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Add Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <style>
        /* Custom DataTables styling */
        .dataTables_wrapper {
            padding: 1rem 0;
        }
        
        .table {
            width: 100% !important;
        }
        
        .table > :not(caption) > * > * {
            padding: 0.75rem;
            vertical-align: middle;
        }
        
        .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }
        
        /* Column-specific alignment */
        .table th.date-column,
        .table td.date-column {
            text-align: center;
            min-width: 100px;
        }
        
        .table th.amount-column,
        .table td.amount-column {
            text-align: right;
            min-width: 100px;
            max-width: 120px;
            white-space: nowrap;
        }
        
        .table th.description-column,
        .table td.description-column {
            text-align: left;
            min-width: 200px;
        }

        .table th.payee-column,
        .table td.payee-column {
            text-align: left;
            min-width: 150px;
        }

        .table th.source-column,
        .table td.source-column {
            text-align: left;
            min-width: 200px;
        }

        /* Add colors for positive/negative amounts */
        .text-success {
            color: #198754 !important;
        }

        .text-danger {
            color: #dc3545 !important;
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        /* Add styles for selected rows */
        .selected {
            background-color: #e2e6ea !important;
        }
        
        /* Style for action buttons */
        .action-buttons {
            margin-bottom: 1rem;
        }
        
        .action-buttons button {
            margin-right: 0.5rem;
        }
        
        /* Add styles for selection checkboxes */
        .select-checkbox {
            width: 30px;
            text-align: center;
        }
        
        /* Add styles for action buttons */
        .action-buttons {
            margin-bottom: 1rem;
        }
        
        .action-buttons button {
            margin-right: 0.5rem;
        }
        
        /* Edit modal styles */
        .modal-body .form-group {
            margin-bottom: 1rem;
        }
        
        /* Selected row highlight */
        tr.selected {
            background-color: #e2e6ea !important;
        }

        .delete-selected-btn {
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2>Data Lake Management</h2>
        
        <!-- File Upload -->
        <div class="card mt-4">
            <div class="card-header">Upload File</div>
            <div class="card-body">
                <form id="uploadForm">
                    <div class="mb-3">
                        <label for="file" class="form-label">Select File</label>
                        <input type="file" class="form-control" id="file" name="file">
                    </div>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </form>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Transaction Database</h5>
                    <div class="action-buttons">
                        <button id="deleteSelected" class="btn btn-danger" disabled>
                            Delete Selected (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Add search form -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" id="searchQuery" class="form-control" placeholder="Search transactions...">
                            <button class="btn btn-primary" type="button" id="searchButton">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" value="description" id="searchDescription" checked>
                            <label class="form-check-label" for="searchDescription">Description</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" value="payee" id="searchPayee" checked>
                            <label class="form-check-label" for="searchPayee">Payee</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" value="amount" id="searchAmount">
                            <label class="form-check-label" for="searchAmount">Amount</label>
                        </div>
                    </div>
                </div>
                
                <div id="transactionData" class="table-responsive"></div>
            </div>
        </div>

        <!-- File Management -->
        <div class="card mt-4">
            <div class="card-header">Files in Data Lake</div>
            <div class="card-body">
                <div id="fileList"></div>
            </div>
        </div>

        <!-- Delete Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Delete File</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete <span id="deleteFileName"></span>?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Move Modal -->
        <div class="modal fade" id="moveModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Move File</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label>Source File:</label>
                            <input type="text" class="form-control" id="moveSource" readonly>
                        </div>
                        <div class="mb-3">
                            <label>Select Destination:</label>
                            <select class="form-select" id="moveDestination">
                                <option value="">Choose destination...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>New Filename (optional):</label>
                            <input type="text" class="form-control" id="moveNewFilename" placeholder="Leave empty to keep original name">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-warning" id="confirmMove">Move</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="loadingOverlay">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Edit Entry Modal -->
        <div class="modal fade" id="editModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Entry</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editForm">
                            <input type="hidden" id="editTimestamp">
                            <div class="form-group">
                                <label for="editDate">Date</label>
                                <input type="date" class="form-control" id="editDate" required>
                            </div>
                            <div class="form-group">
                                <label for="editAmount">Amount</label>
                                <input type="number" step="0.01" class="form-control" id="editAmount" required>
                            </div>
                            <div class="form-group">
                                <label for="editDescription">Description</label>
                                <input type="text" class="form-control" id="editDescription">
                            </div>
                            <div class="form-group">
                                <label for="editPayee">Payee</label>
                                <input type="text" class="form-control" id="editPayee">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveEdit">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // File upload handler
            document.getElementById('uploadForm').onsubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData();
                formData.append('file', document.getElementById('file').files[0]);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    alert(result.message || result.error);
                    loadFiles();
                    await loadTransactions();  // Add this line
                } catch (error) {
                    alert('Error uploading file');
                }
            };

            // Delete file handler
            async function deleteFile(path) {
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                document.getElementById('deleteFileName').textContent = path;
                
                const confirmDelete = document.getElementById('confirmDelete');
                confirmDelete.onclick = async () => {
                    try {
                        const response = await fetch(`/delete/${encodeURIComponent(path)}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        if (response.ok) {
                            showAlert('success', result.message);
                            loadFiles();
                        } else {
                            showAlert('danger', result.error);
                        }
                    } catch (error) {
                        showAlert('danger', 'Error deleting file');
                    }
                    deleteModal.hide();
                };
                
                deleteModal.show();
            }

            // Add directory loading function
            async function loadDirectories() {
                try {
                    const response = await fetch('/directories');
                    const directories = await response.json();
                    const select = document.getElementById('moveDestination');
                    select.innerHTML = '<option value="">Choose destination...</option>' +
                        directories.map(dir => `<option value="${dir}">${dir}</option>`).join('');
                } catch (error) {
                    showAlert('danger', 'Error loading directories');
                }
            }

            // Move file handler
            async function moveFile(source) {
                const moveModal = new bootstrap.Modal(document.getElementById('moveModal'));
                document.getElementById('moveSource').value = source;
                document.getElementById('moveNewFilename').value = '';
                
                // Load directories
                await loadDirectories();
                
                const confirmMove = document.getElementById('confirmMove');
                confirmMove.onclick = async () => {
                    const destDir = document.getElementById('moveDestination').value;
                    const newFilename = document.getElementById('moveNewFilename').value;
                    
                    if (!destDir) {
                        showAlert('warning', 'Please select destination directory');
                        return;
                    }

                    // Construct destination path
                    const originalFilename = source.split('/').pop();
                    const destination = destDir + '/' + (newFilename || originalFilename);

                    try {
                        const response = await fetch('/move', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ source, destination })
                        });
                        const result = await response.json();
                        if (response.ok) {
                            showAlert('success', result.message);
                            loadFiles();
                        } else {
                            showAlert('danger', result.error);
                        }
                    } catch (error) {
                        showAlert('danger', 'Error moving file');
                    }
                    moveModal.hide();
                };
                
                moveModal.show();
            }

            // Add alert function
            function showAlert(type, message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.card'));
                
                // Auto-dismiss after 3 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 3000);
            }

            // Update loadFiles function
            async function loadFiles() {
                try {
                    const response = await fetch('/files');
                    const files = await response.json();
                    const fileList = document.getElementById('fileList');
                    
                    if (files.length === 0) {
                        fileList.innerHTML = '<div class="alert alert-info">No files found</div>';
                        return;
                    }
                    
                    fileList.innerHTML = files.map(file => {
                        // Ensure proper path construction with slash
                        const filePath = `${file.zone}/${file.name}`;  // Changed this line
                        return `
                            <div class="mb-2 p-2 border rounded">
                                <strong>${file.zone}:</strong> ${file.name}
                                <div class="float-end">
                                    <button onclick="deleteFile('${filePath}')" class="btn btn-sm btn-danger">Delete</button>
                                    <button onclick="moveFile('${filePath}')" class="btn btn-sm btn-warning">Move</button>
                                    <a href="/view/${encodeURIComponent(filePath)}" class="btn btn-sm btn-info">View</a>
                                </div>
                            </div>
                        `;
                    }).join('');
                } catch (error) {
                    showAlert('danger', 'Error loading files');
                }
            }

            // Add this function to load transactions
            async function loadTransactions() {
                try {
                    // Show loading state
                    document.getElementById('transactionData').innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';
                    
                    const response = await fetch('/transactions');
                    const result = await response.json();
                    const transactionDiv = document.getElementById('transactionData');
                    
                    if (result.error) {
                        transactionDiv.innerHTML = `<div class="alert alert-danger">${result.error}</div>`;
                        return;
                    }
                    
                    if (!result.data) {
                        transactionDiv.innerHTML = '<div class="alert alert-warning">No data available</div>';
                        return;
                    }
                    
                    transactionDiv.innerHTML = result.data;

                    // Initialize DataTable only if the table exists
                    const table = document.getElementById('transactionTable');
                    if (table) {
                        try {
                            // Destroy existing DataTable if it exists
                            if ($.fn.DataTable.isDataTable('#transactionTable')) {
                                $('#transactionTable').DataTable().destroy();
                            }
                            
                            // Initialize new DataTable
                            $('#transactionTable').DataTable({
                                pageLength: 10,
                                order: [[0, 'desc']], // Sort by date descending
                                searching: true,
                                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
                                responsive: true,
                                columnDefs: [
                                    {
                                        targets: [0], // Date column
                                        className: 'date-column',
                                        render: function(data) {
                                            return data ? new Date(data).toLocaleDateString() : '';
                                        }
                                    },
                                    {
                                        targets: [1], // Amount column
                                        className: 'amount-column',
                                        render: function(data) {
                                            const num = parseFloat(data);
                                            if (isNaN(num)) return '';
                                            const formatted = Math.abs(num).toFixed(2);
                                            return num >= 0 ? 
                                                `<span class="text-success">+${formatted}</span>` : 
                                                `<span class="text-danger">-${formatted}</span>`;
                                        }
                                    },
                                    {
                                        targets: [2], // Description column
                                        className: 'description-column'
                                    },
                                    {
                                        targets: [3], // Payee column
                                        className: 'payee-column'
                                    },
                                    {
                                        targets: [4], // Source column
                                        className: 'source-column',
                                        render: function(data) {
                                            return data ? data : '';
                                        }
                                    },
                                    {
                                        targets: 0,
                                        width: '30px',
                                        className: 'select-checkbox',
                                        orderable: false,
                                        render: function() {
                                            return '<input type="checkbox" class="select-checkbox">';
                                        }
                                    },
                                    {
                                        targets: -1,
                                        width: '120px',
                                        orderable: false,
                                        render: function(data, type, row) {
                                            return `
                                                <button class="btn btn-sm btn-primary edit-entry">Edit</button>
                                                <button class="btn btn-sm btn-danger delete-entry">Delete</button>
                                            `;
                                        }
                                    }
                                ],
                                // Add error handling for DataTables
                                drawCallback: function(settings) {
                                    console.log('DataTable draw complete');
                                },
                                initComplete: function(settings, json) {
                                    console.log('DataTable initialization complete');
                                }
                            });
                            console.log('DataTable initialized successfully');
                        } catch (e) {
                            console.error('Error initializing DataTable:', e);
                            transactionDiv.innerHTML += `
                                <div class="alert alert-warning mt-3">
                                    Table features may be limited. Error: ${e.message}
                                </div>`;
                        }
                    }
                } catch (error) {
                    console.error('Error in loadTransactions:', error);
                    document.getElementById('transactionData').innerHTML = 
                        `<div class="alert alert-danger">Error loading transactions: ${error.message}</div>`;
                }
            }

            // Call loadTransactions when page loads
            document.addEventListener('DOMContentLoaded', () => {
                loadTransactions();
            });

            // Update loadFiles to also refresh transactions
            const originalLoadFiles = loadFiles;
            loadFiles = async () => {
                await originalLoadFiles();
                await loadTransactions();
            };

            loadFiles();

            // Update initializeDataTable function in index.html
            function initializeDataTable(tableId) {
                const table = $(`#${tableId}`).DataTable({
                    pageLength: 10,
                    order: [[1, 'desc']], // Date column (index 1) descending
                    columnDefs: [
                        {
                            // Add checkbox column as first column
                            targets: 0,
                            orderable: false,
                            className: 'select-checkbox',
                            render: function() {
                                return '<input type="checkbox" class="row-select">';
                            }
                        }
                    ],
                    // Add select header checkbox
                    headerCallback: function(thead) {
                        if (!$(thead).find('th').eq(0).find('.select-all').length) {
                            $(thead).find('th').eq(0).html(
                                '<input type="checkbox" class="select-all">'
                            );
                        }
                    }
                });

                // Add selection handlers
                addSelectionHandlers(table);
                
                return table;
            }

            function addSelectionHandlers(table) {
                // Handle "Select All" checkbox
                table.on('click', '.select-all', function() {
                    const checked = $(this).prop('checked');
                    table.find('.row-select').prop('checked', checked);
                    table.find('tbody tr').toggleClass('selected', checked);
                    updateDeleteButton();
                });

                // Handle individual row selection
                table.on('click', '.row-select', function(e) {
                    const $row = $(this).closest('tr');
                    $row.toggleClass('selected', this.checked);
                    
                    // Update "Select All" checkbox state
                    const allChecked = table.find('.row-select:checked').length === table.find('.row-select').length;
                    table.find('.select-all').prop('checked', allChecked);
                    
                    updateDeleteButton();
                });

                // Add delete button if not exists
                if (!$('.delete-selected-btn').length) {
                    const deleteBtn = $(`
                        <button class="btn btn-danger delete-selected-btn" disabled>
                            Delete Selected (<span class="selected-count">0</span>)
                        </button>
                    `);
                    
                    deleteBtn.on('click', deleteSelectedEntries);
                    $(`#${table.table().node().id}_wrapper`).prepend(deleteBtn);
                }
            }

            function updateDeleteButton() {
                const selectedCount = $('.row-select:checked').length;
                const $deleteBtn = $('.delete-selected-btn');
                $deleteBtn.prop('disabled', selectedCount === 0);
                $('.selected-count').text(selectedCount);
            }

            async function deleteSelectedEntries() {
                const selectedRows = $('tr.selected');
                if (!selectedRows.length) return;

                if (!confirm(`Delete ${selectedRows.length} selected entries?`)) return;

                const timestamps = selectedRows.map(function() {
                    return $(this).find('td:eq(1)').text(); // Get timestamp from second column
                }).get();

                try {
                    const response = await fetch('/entries/delete-multiple', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ timestamps })
                    });

                    const result = await response.json();
                    if (response.ok) {
                        showAlert('success', result.message);
                        await loadTransactions(); // Reload table data
                    } else {
                        showAlert('danger', result.error);
                    }
                } catch (error) {
                    showAlert('danger', 'Error deleting entries');
                }
            }

            function showLoadingOverlay() {
                document.getElementById('loadingOverlay').style.display = 'flex';
            }

            function hideLoadingOverlay() {
                document.getElementById('loadingOverlay').style.display = 'none';
            }

            async function refreshApp() {
                showLoadingOverlay();
                try {
                    const response = await fetch('/refresh');
                    const result = await response.json();
                    console.log(result.message);
                    loadFiles();
                    loadTransactions();
                } catch (error) {
                    console.error('Error refreshing app:', error);
                } finally {
                    hideLoadingOverlay();
                }
            }

            // Call refreshApp when the page loads
            document.addEventListener('DOMContentLoaded', () => {
                refreshApp();
            });

            // Update searchTransactions function
            async function searchTransactions() {
                try {
                    const query = document.getElementById('searchQuery').value.trim();
                    if (!query) {
                        await loadTransactions();
                        return;
                    }

                    // Show loading indicator
                    document.getElementById('transactionData').innerHTML = 
                        '<div class="text-center"><div class="spinner-border"></div></div>';

                    // Get selected fields
                    const fields = [];
                    if (document.getElementById('searchDescription').checked) fields.push('description');
                    if (document.getElementById('searchPayee').checked) fields.push('payee');
                    if (document.getElementById('searchAmount').checked) fields.push('amount');

                    // Make search request
                    const response = await fetch('/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            query: query,
                            fields: fields
                        })
                    });

                    const result = await response.json();
                    const transactionDiv = document.getElementById('transactionData');

                    if (!response.ok) {
                        transactionDiv.innerHTML = `<div class="alert alert-danger">${result.error || 'Error performing search'}</div>`;
                        return;
                    }

                    // Handle empty results
                    if (!result.data) {
                        transactionDiv.innerHTML = '<div class="alert alert-info">No results found</div>';
                        return;
                    }

                    // Display results
                    transactionDiv.innerHTML = result.data;

                    // Reinitialize DataTable if table exists
                    const table = document.getElementById('transactionTable');
                    if (table) {
                        try {
                            // Destroy existing DataTable if it exists
                            if ($.fn.DataTable.isDataTable('#transactionTable')) {
                                $('#transactionTable').DataTable().destroy();
                            }
                            
                            // Initialize new DataTable
                            initializeDataTable('transactionTable');
                        } catch (e) {
                            console.error('Error initializing DataTable:', e);
                        }
                    }

                } catch (error) {
                    console.error('Search error:', error);
                    document.getElementById('transactionData').innerHTML = 
                        `<div class="alert alert-danger">Error performing search: ${error.message}</div>`;
                }
            }

            // Add event listeners after document ready
            document.addEventListener('DOMContentLoaded', () => {
                const searchButton = document.getElementById('searchButton');
                const searchQuery = document.getElementById('searchQuery');

                if (searchButton) {
                    searchButton.addEventListener('click', searchTransactions);
                }
                
                if (searchQuery) {
                    searchQuery.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            searchTransactions();
                        }
                    });
                }
            });

            // Add these functions to handle entry management
            function addEntryListeners(table) {
                // Add action buttons to each row
                table.on('click', '.edit-entry', function() {
                    const row = table.row($(this).closest('tr'));
                    const data = row.data();
                    openEntryModal('edit', data);
                });

                table.on('click', '.delete-entry', function() {
                    const row = table.row($(this).closest('tr'));
                    const data = row.data();
                    if (confirm('Are you sure you want to delete this entry?')) {
                        deleteEntry(data[0]); // Assuming first column is timestamp
                    }
                });
            }

            async function openEntryModal(mode, data = null) {
                const modal = new bootstrap.Modal(document.getElementById('entryModal'));
                const title = document.getElementById('entryModalTitle');
                const form = document.getElementById('entryForm');
                
                title.textContent = mode === 'edit' ? 'Edit Entry' : 'Add Entry';
                form.reset();
                
                if (data) {
                    document.getElementById('entryTimestamp').value = data[0];
                    document.getElementById('entryDate').value = new Date(data[0]).toISOString().split('T')[0];
                    document.getElementById('entryAmount').value = data[1];
                    document.getElementById('entryDescription').value = data[2];
                    document.getElementById('entryPayee').value = data[3];
                }
                
                modal.show();
            }

            async function saveEntry() {
                const timestamp = document.getElementById('entryTimestamp').value;
                const date = new Date(document.getElementById('entryDate').value).getTime();
                const amount = parseFloat(document.getElementById('entryAmount').value);
                const description = document.getElementById('entryDescription').value;
                const payee = document.getElementById('entryPayee').value;
                
                const entryData = {
                    date,
                    amount,
                    description,
                    payee,
                    source_file: 'manual_entry'
                };
                
                try {
                    const response = await fetch(timestamp ? `/entry/${timestamp}` : '/entry', {
                        method: timestamp ? 'PUT' : 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(entryData)
                    });
                    
                    if (response.ok) {
                        showAlert('success', 'Entry saved successfully');
                        bootstrap.Modal.getInstance(document.getElementById('entryModal')).hide();
                        await loadTransactions();
                    } else {
                        const error = await response.json();
                        showAlert('danger', error.error);
                    }
                } catch (error) {
                    showAlert('danger', 'Error saving entry');
                }
            }

            async function deleteEntry(timestamp) {
                try {
                    const response = await fetch(`/entry/${timestamp}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        showAlert('success', 'Entry deleted successfully');
                        await loadTransactions();
                    } else {
                        const error = await response.json();
                        showAlert('danger', error.error);
                    }
                } catch (error) {
                    showAlert('danger', 'Error deleting entry');
                }
            }

            // Add event listener for saving entries
            document.getElementById('saveEntry').addEventListener('click', saveEntry);

            function updateSelectedCount() {
                const selectedRows = document.querySelectorAll('tr.selected').length;
                const deleteButton = document.getElementById('deleteSelected');
                const countSpan = document.getElementById('selectedCount');
                
                deleteButton.disabled = selectedRows === 0;
                countSpan.textContent = selectedRows ? `${selectedRows} selected` : '';
            }

            async function deleteSelectedEntries() {
                const selectedRows = document.querySelectorAll('tr.selected');
                if (!selectedRows.length) return;

                if (!confirm(`Are you sure you want to delete ${selectedRows.length} entries?`)) return;

                const timestamps = Array.from(selectedRows).map(row => {
                    return row.querySelector('td:nth-child(2)').textContent; // Assuming date is in second column
                });

                try {
                    const response = await fetch('/entries/delete-multiple', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ timestamps })
                    });

                    const result = await response.json();
                    if (response.ok) {
                        showAlert('success', result.message);
                        await loadTransactions();
                    } else {
                        showAlert('danger', result.error);
                    }
                } catch (error) {
                    showAlert('danger', 'Error deleting entries');
                }
            }

            // Add event listeners
            document.addEventListener('DOMContentLoaded', () => {
                // ...existing listeners...
                
                document.getElementById('addEntry').addEventListener('click', () => openEntryModal('add'));
                document.getElementById('deleteSelected').addEventListener('click', deleteSelectedEntries);
            });

            // Add these new functions
            function openEditModal(rowData) {
                const timestamp = new Date(rowData[2]).getTime();
                $('#editTimestamp').val(timestamp);
                $('#editDate').val(rowData[2]);
                $('#editAmount').val(parseFloat(rowData[3].replace(/[^-.\d]/g, '')));
                $('#editDescription').val(rowData[4]);
                $('#editPayee').val(rowData[5]);
                
                const editModal = new bootstrap.Modal(document.getElementById('editModal'));
                editModal.show();
            }

            async function saveEdit() {
                const timestamp = $('#editTimestamp').val();
                const data = {
                    date: new Date($('#editDate').val()).getTime(),
                    amount: parseFloat($('#editAmount').val()),
                    description: $('#editDescription').val(),
                    payee: $('#editPayee').val(),
                    source_file: 'manual_entry'
                };

                try {
                    const response = await fetch(`/entry/${timestamp}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        showAlert('success', 'Entry updated successfully');
                        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                        await loadTransactions();
                    } else {
                        const error = await response.json();
                        showAlert('danger', error.error);
                    }
                } catch (error) {
                    showAlert('danger', 'Error updating entry');
                }
            }

            async function deleteEntry(timestamp) {
                try {
                    const response = await fetch(`/entry/${timestamp}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        showAlert('success', 'Entry deleted successfully');
                        await loadTransactions();
                    } else {
                        const error = await response.json();
                        showAlert('danger', error.error);
                    }
                } catch (error) {
                    showAlert('danger', 'Error deleting entry');
                }
            }

            // In templates/index.html and templates/view.html
            $(document).ready(function() {
                initializeDataTable('transactionTable'); // or your table ID
            });
        </script>
    </div>
</body>
</html>